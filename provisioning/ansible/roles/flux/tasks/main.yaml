- name: Check if Flux is already installed
  shell: kubectl get ns flux-system
  register: flux_check
  failed_when: false
  changed_when: false

- name: Install Flux CLI
  shell: |
    curl -s https://fluxcd.io/install.sh | bash
  when: flux_check.rc != 0

- name: Bootstrap FluxCD to GitHub
  shell: |
    flux bootstrap github \
      --owner=kristiangogov \
      --repository=homelab \
      --branch=staging \
      --path=clusters/staging \
      --personal \
      --token-auth
  environment:
    GITHUB_TOKEN: "{{ vault_github_token }}"
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  when: flux_check.rc != 0
  run_once: true

- name: Create sops-age secret for FluxCD
  kubernetes.core.k8s:
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: sops-age
        namespace: flux-system
      type: Opaque
      stringData:
        age.agekey: "{{ sops_age_private_key }}" 

- name: Wait for Flux to be ready
  shell: kubectl wait --for=condition=ready pod -l app=source-controller -n flux-system --timeout=120s
  when: flux_check.rc != 0